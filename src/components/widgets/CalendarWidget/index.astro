<div
  class="card bg-base-100/50 backdrop-blur-sm p-6 shadow-lg h-full flex flex-col"
>
  <!-- Subtle refresh button -->
  <button
    id="refresh-calendar-btn"
    class="absolute bottom-2 right-2 p-2 rounded-full bg-base-100/30 hover:bg-base-100/50 backdrop-blur-sm transition-all opacity-50 hover:opacity-100"
    aria-label="Refresh calendar"
    title="Refresh calendar events"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5 text-base-content"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
      ></path>
    </svg>
  </button>

  <div
    class="calendar-container space-y-4 overflow-y-auto overflow-x-hidden flex-1 pr-2"
  >
    <div class="flex items-center justify-center py-8 text-base-content/50">
      Loading calendar events...
    </div>
  </div>
</div>

<script>
  import calendarEvents from '../../../lib/client/calendarEvents'
  import moment from 'moment'

  // Helper function to convert hex color to rgba
  function hexToRgba(hex: string, alpha: number): string {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex)
    return result
      ? `rgba(${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}, ${alpha})`
      : `rgba(59, 130, 246, ${alpha})`
  }

  // Helper function to generate gradient style like in CalendarEvent.astro
  function getGradientStyle(color: string, colorfull: boolean = false): string {
    if (colorfull) {
      return `border-left-color: ${color}; background: linear-gradient(to right, ${hexToRgba(color, 0.05)}, ${hexToRgba(color, 0)});`
    }
    return `border-left-color: ${color};`
  }

  async function loadCalendar() {
    try {
      const calendarDays = await calendarEvents.getCalendar()
      const today = moment().startOf('day')

      // Transform Day objects to the format expected by CalendarDay component
      const formattedDays = calendarDays.map((day) => {
        const events = day.getEvents().map((event) => ({
          title: event.summary,
          startTime: moment(event.start).format('HH:mm'),
          endTime: moment(event.end).format('HH:mm'),
          location: event.location,
          color: event.color || '#3b82f6',
          allDay: event.isAllDayEvent,
        }))

        const dayDate = moment(day.getDate()).startOf('day')
        const isToday = dayDate.isSame(today, 'day')

        return {
          dayLabel: day.getDayLabel(),
          dayNumber: day.getDayNumber(),
          month: day.getMonth(),
          isToday,
          events,
        }
      })

      // Update the DOM with the calendar data
      const container = document.querySelector('.calendar-container')
      if (container) {
        // Re-render the calendar days matching CalendarDay.astro structure
        container.innerHTML = formattedDays
          .map(
            (day) => `
          <div class="flex gap-4 mb-6 items-center">
            <div class="flex flex-col items-center ml-1 justify-center min-w-[80px] text-center">
              <span class="text-sm font-medium text-base-content/70 uppercase">${day.dayLabel}</span>
              <span class="text-4xl mt-1 mb-1 font-bold ${day.isToday ? 'ring-2 ring-secondary/30 bg-secondary/10 rounded-full w-16 h-16 flex items-center justify-center' : ''} text-base-content">${day.dayNumber}</span>
              <span class="text-sm font-medium text-base-content/70 uppercase">${day.month}</span>
            </div>
            <div class="flex-1 min-w-0 space-y-1">
              ${day.events
                .map(
                  (event) => `
                <div class="relative pl-4 py-3 backdrop-blur-sm rounded-e-lg border-l-4 overflow-hidden" style="${getGradientStyle(event.color, true)}">
                  <div class="flex items-center gap-2 flex-wrap mb-1">
                    <h3 class="${event.allDay ? 'text-sm' : 'text-base'} font-semibold text-base-content break-words">
                      ${event.title}
                    </h3>
                    ${event.allDay ? '<span class="text-xs px-2 py-0.5 rounded-full bg-primary/20 text-primary font-medium whitespace-nowrap">All Day</span>' : ''}
                  </div>
                  <div class="flex items-center gap-2 text-sm text-base-content/70">
                    ${!event.allDay ? `<span>${event.startTime} - ${event.endTime}</span>` : ''}
                  </div>
                  ${
                    event.location
                      ? `
                  <div class="flex items-center gap-2 text-sm text-base-content/70 mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="break-words">${event.location}</span>
                  </div>
                  `
                      : ''
                  }
                </div>
              `,
                )
                .join('')}
            </div>
          </div>
        `,
          )
          .join('')
      }
    } catch (error) {
      console.error('Failed to load calendar events:', error)
      const container = document.querySelector('.calendar-container')
      if (container) {
        container.innerHTML = `
          <div class="flex items-center justify-center py-8 text-error">
            <p>Failed to load calendar events. Please check the console for details.</p>
          </div>
        `
      }
    }
  }

  async function refreshCalendar() {
    const container = document.querySelector('.calendar-container')
    const button = document.querySelector('#refresh-calendar-btn')

    if (button) {
      // Add spinning animation to button
      button.classList.add('animate-spin')
    }

    if (container) {
      // Show refreshing indicator
      container.innerHTML = `
        <div class="flex items-center justify-center py-8 text-base-content/50">
          <div class="flex flex-col items-center gap-2">
            <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>Refreshing calendar...</p>
          </div>
        </div>
      `
    }

    // Clear cache and reload
    calendarEvents.clearCache()
    await loadCalendar()

    if (button) {
      // Remove spinning animation
      button.classList.remove('animate-spin')
    }
  }

  // Load calendar on page load
  loadCalendar()

  // Re-fetch calendar data every 1 hour
  setInterval(
    () => {
      loadCalendar()
    },
    60 * 60 * 1000,
  ) // 1 hour in milliseconds

  // Attach refresh button click handler
  const refreshBtn = document.querySelector('#refresh-calendar-btn')
  if (refreshBtn) {
    refreshBtn.addEventListener('click', refreshCalendar)
  }
</script>
